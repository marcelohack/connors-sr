name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-environment:
    name: Build Environment
    uses: ./.github/workflows/build-env.yml
    with:
      python-version: "3.13"

  lint-and-security:
    name: Lint and Security
    runs-on: ubuntu-24.04
    needs: build-environment
    if: needs.build-environment.outputs.environment-ready == 'true'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Environment Artifact
      uses: actions/download-artifact@v4
      with:
        name: build-environment-${{ needs.build-environment.outputs.cache-key }}
        path: environment-info/

    - name: Set Up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: 'pip'
        cache-dependency-path: pyproject.toml

    - name: Restore Environment Variables
      run: |
        if [ -f environment-info/environment.env ]; then
          cat environment-info/environment.env >> $GITHUB_ENV
        fi

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "connors-datafetch @ git+https://github.com/marcelohack/connors-datafetch.git@main"
        pip install -e ".[dev]"

    - name: Black Formatting Check
      run: |
        black --check connors_sr/ tests/
      continue-on-error: true

    - name: Isort Import Order Check
      run: |
        isort --check-only connors_sr/ tests/
      continue-on-error: true

    - name: Flake8 Linting
      run: |
        flake8 connors_sr/
      continue-on-error: true

    - name: Mypy Static Type Checking
      run: |
        mypy connors_sr/ --ignore-missing-imports
      continue-on-error: true

    - name: Bandit Security Scan
      run: |
        bandit -c pyproject.toml -r connors_sr/
      continue-on-error: true

  test:
    name: Test Suite
    runs-on: ubuntu-24.04
    needs: build-environment
    if: needs.build-environment.outputs.environment-ready == 'true'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Environment Artifact
      uses: actions/download-artifact@v4
      with:
        name: build-environment-${{ needs.build-environment.outputs.cache-key }}
        path: environment-info/

    - name: Set Up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: 'pip'
        cache-dependency-path: pyproject.toml

    - name: Restore Environment Variables
      run: |
        if [ -f environment-info/environment.env ]; then
          cat environment-info/environment.env >> $GITHUB_ENV
        fi

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "connors-datafetch @ git+https://github.com/marcelohack/connors-datafetch.git@main"
        pip install -e ".[dev]"

    - name: Pytest Testing (no coverage)
      run: |
        pytest tests/ --tb=short -v --no-cov

    - name: Coverage report with pytest-cov
      run: |
        pytest tests/ --cov=connors_sr --cov-report=xml --cov-report=html --cov-report=term-missing
      continue-on-error: true
